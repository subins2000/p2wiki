(this.webpackJsonpp2wiki=this.webpackJsonpp2wiki||[]).push([[0],{208:function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return d}));var r=n(61),i=n(62),o=n(211),a=n(210),s=n(100),c=n(22),u=n(5),l=n(27),f=n(118)("p2pt"),d=function(t){Object(o.a)(u,t);var n=Object(a.a)(u);function u(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return Object(r.a)(this,u),(e=n.call(this)).announceURLs=t,e.trackers={},e.peers={},e.msgChunks={},e.responseWaiting={},i&&e.setIdentifier(i),e._peerIdBuffer=c(20),e._peerId=e._peerIdBuffer.toString("hex"),e._peerIdBinary=e._peerIdBuffer.toString("binary"),e}return Object(i.a)(u,[{key:"setIdentifier",value:function(t){this.identifierString=t,this.infoHash=l.sync(t).toLowerCase(),this._infoHashBuffer=e.from(this.infoHash,"hex"),this._infoHashBinary=this._infoHashBuffer.toString("binary")}},{key:"start",value:function(){var e=this;this.on("peer",(function(t){var n=!1;e.peers[t.id]||(n=!0,e.peers[t.id]={},e.responseWaiting[t.id]={}),t.on("connect",(function(){e.peers[t.id][t.channelName]=t,n&&e.emit("peerconnect",t)})),t.on("data",(function(n){if(e.emit("data",t,n),n=n.toString(),f("got a message from "+t.id),"p"===n[0])try{n=JSON.parse(n.slice(1)),t.respond=e._peerRespond(t,n.id);var r=e._chunkHandler(n);!1!==r&&(e.responseWaiting[t.id][n.id]?(e.responseWaiting[t.id][n.id]([t,r]),delete e.responseWaiting[t.id][n.id]):e.emit("msg",t,r),e._destroyChunks(n.id))}catch(i){console.log(i)}})),t.on("error",(function(n){e.removePeer(t),f("Error in connection : "+n)})),t.on("close",(function(){e.removePeer(t),f("Connection closed with "+t.id)}))})),this._fetchPeers()}},{key:"removePeer",value:function(e){delete this.peers[e.id][e.channelName],0===this.peers[e.id].length&&(this.emit("peerclose",e),delete this.responseWaiting[e.id],delete this.peers[e.id])}},{key:"send",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=this;return new Promise((function(i,o){var a={id:""!==n?n:Math.floor(1e5*Math.random()+1e5),msg:t};try{e.connected||(e=r.peers[e.id][0]),r.responseWaiting[e.id][a.id]=i}catch(u){return o(Error("Connection to peer closed"))}for(var s=0,c="";a.msg.length>0;)a.c=s,c=a.msg.slice(16e3),a.msg=a.msg.slice(0,16e3),c||(a.last=!0),e.send("p"+JSON.stringify(a)),a.msg=c,s++;f("sent a message to "+e.id)}))}},{key:"requestMorePeers",value:function(){var e=this;return new Promise((function(t){for(var n in e.trackers)e.trackers[n].announce({numwant:50});t(e.peers)}))}},{key:"destroy",value:function(){var e;for(e in this.peers)for(var t in this.peers[e])this.peers[e][t].destroy();for(e in this.trackers)this.trackers[e].destroy()}},{key:"_peerRespond",value:function(e,t){var n=this;return function(r){return n.send(e,r,t)}}},{key:"_chunkHandler",value:function(e){return this.msgChunks[e.id]||(this.msgChunks[e.id]=[]),this.msgChunks[e.id][e.c]=e.msg,!!e.last&&this.msgChunks[e.id].join("")}},{key:"_destroyChunks",value:function(e){delete this.msgChunks[e]}},{key:"_defaultAnnounceOpts",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return null==e.numwant&&(e.numwant=50),null==e.uploaded&&(e.uploaded=0),null==e.downloaded&&(e.downloaded=0),e}},{key:"_fetchPeers",value:function(){for(var e in this.announceURLs)this.trackers[e]=new s(this,this.announceURLs[e]),this.trackers[e].announce({numwant:50})}}]),u}(u)}).call(this,n(2).Buffer)},212:function(e,t,n){e.exports=n(454)},217:function(e,t,n){},249:function(e,t){},251:function(e,t){},261:function(e,t){},263:function(e,t){},268:function(e,t){},269:function(e,t){},279:function(e,t){},281:function(e,t){},289:function(e,t){},291:function(e,t){},301:function(e,t){},303:function(e,t){},310:function(e,t){},312:function(e,t){},317:function(e,t){},320:function(e,t){},321:function(e,t){},324:function(e,t){},326:function(e,t){},328:function(e,t){},342:function(e,t){},347:function(e,t){},349:function(e,t){},358:function(e,t){},360:function(e,t){},361:function(e,t){},363:function(e,t){},365:function(e,t){},366:function(e,t){},369:function(e,t){},375:function(e,t){},378:function(e,t){},380:function(e,t){},392:function(e,t){},394:function(e,t){},407:function(e,t){},409:function(e,t){},423:function(e,t){},425:function(e,t){},438:function(e,t){},440:function(e,t){},447:function(e,t){},452:function(e,t,n){},453:function(e,t,n){},454:function(e,t,n){"use strict";n.r(t);var r=n(1),i=n.n(r),o=n(207),a=n.n(o),s=(n(217),n(87)),c=n(11),u=n(51),l=n(61),f=n(62),d=n(63),h=n.n(d),p=n(208),m=n(274),g=n(35),v=n(118)("p2wiki"),y=function(){function e(t){Object(l.a)(this,e),this.announceURLs=t,this.proxyPeers={},this.proxyPeersID=[],this.curProxyPeerIndex=0,this.seedingTorrents={},this.wt=new m,this.p2pt=new p.a(t,"p2wiki")}return Object(f.a)(e,[{key:"startProxy",value:function(){var e=this;this.p2pt.on("msg",(function(t,n){if("c"===n)t.respond("p").catch((function(e){console.error("Connection to client failed before handsahake. "+e)}));else try{n=JSON.parse(n);var r=encodeURIComponent(n.articleName);console.log("Got request for article "+r),e.makeArticleTorrent(n.articleName).then((function(e){t.respond(e.infoHash)})).catch((function(t){console.log("Torrent creation failed : "+t),delete e.seedingTorrents[r]}))}catch(i){console.log(i)}})),this.p2pt.start(),g([function(){setInterval((function(){var t,n=new Date;for(var r in e.seedingTorrents)(t=e.seedingTorrents[r]).lastActive&&n-t.lastActive>12e4&&t.torrent.destroy()}),1e4)}])}},{key:"startClient",value:function(){var e=this,t=this;this.p2pt.on("peerconnect",(function(e){t.p2pt.send(e,"c").then((function(e){var n=Object(u.a)(e,2),r=n[0],i=n[1];console.log(r.id),"p"===i&&(t.proxyPeers[r.id]?r.destroy():(t.proxyPeers[r.id]=r,t.proxyPeersID.push(r.id)))}))})),this.p2pt.on("peerclose",(function(n){delete t.proxyPeers[n],delete t.proxyPeersID[e.proxyPeersID.indexOf(n)]})),this.p2pt.start()}},{key:"getAProxyPeer",value:function(){return 0!==this.proxyPeersID.length&&(this.curProxyPeerIndex>this.proxyPeersID.length-1&&(this.curProxyPeerIndex=0),this.proxyPeers[this.proxyPeersID[this.curProxyPeerIndex]])}},{key:"makeArticleTorrent",value:function(e){var t=this;return new Promise((function(n,r){if(e=encodeURIComponent(e),t.seedingTorrents[e])t.seedingTorrents[e].torrent&&n(t.seedingTorrents[e].torrent);else{t.seedingTorrents[e]={};var i=[],o={title:"",article:!1,media:[],mediaCount:0},a=function(){o.article&&o.media.length===o.mediaCount&&t.wt.seed(i,{announceList:[t.announceURLs],name:o.title},(function(r){t.seedingTorrents[e]={lastActive:new Date,torrent:r},r.on("upload",(function(){t.seedingTorrents[e].lastActive=new Date})),v("Started seeding article '".concat(e,"' : ").concat(r.infoHash)),n(r)}))};h.a.get("//en.wikipedia.org/w/api.php?action=parse&format=json&page=".concat(e,"&prop=text&formatversion=2&origin=*")).then((function(t){var n=new window.File([t.data.parse.text],"article.html",{type:"text/html"});i.push(n),o.title=t.data.parse.title,o.article=!0,v("Article ".concat(e," : Fetched text")),a()})).catch((function(e){r(e)}));var s=function(t,n){h()({method:"get",url:n,responseType:"blob"}).then((function(n){var r=t,s=new window.File([n.data],r,{type:n.headers["content-type"]});i.push(s),o.media.push(r),v("Article ".concat(e," : Fetched image ").concat(o.media.length,"/").concat(o.mediaCount)),a()})).catch((function(e){r(e)}))};h.a.get("//en.wikipedia.org/api/rest_v1/page/media-list/".concat(e)).then((function(t){var n;for(var r in t.data.items)(n=t.data.items[r]).srcset&&(s(n.title,n.srcset[0].src),o.mediaCount++);v("Article ".concat(e," : Fetched medialist. Has ").concat(o.mediaCount," images"))})).catch((function(e){r(e)}))}}))}},{key:"requestArticle",value:function(e,t,n){if(this.p2pt.requestMorePeers(),0===this.proxyPeers.length)return!1;var r,i=this,o=[];for(var a in this.proxyPeers)r=this.proxyPeers[a],this.p2pt.send(r,JSON.stringify({articleName:e})).then((function(e){var n=Object(u.a)(e,2),r=(n[0],n[1]);o.push(r);var a=i.checkConsensus(o);a&&i.downloadTorrent(a,t)}))}},{key:"checkConsensus",value:function(e){var t,n={};for(var r in e)if(n[t=e[r]]||(n[t]=0),n[t]++,n[t]>=1)return t;return!1}},{key:"downloadTorrent",value:function(e,t){var n=function(e){var n={title:"",text:null,media:{}};e.files.forEach((function(t){"article.html"===t.name?(n.title=e.name,n.text=t):n.media[t.name]=t})),t(n)};this.wt.get(e)?n(this.wt.get(e)):this.wt.add(e,{announce:this.announceURLs},n)}}]),e}(),w=function(){return i.a.createElement("h1",{style:{color:"royalblue",fontSize:"50px"}},"P2Wiki")},k=function(e){var t=e.query,n=e.handleChange,r=e.handleSubmit;return i.a.createElement("form",{onSubmit:r},i.a.createElement("div",{className:"field"},i.a.createElement("div",{style:{textAlign:"center"},className:"control"},i.a.createElement("input",{className:"input is-rounded",id:"query",type:"Text",placeholder:"\ud83d\udd0d Search for an article",onChange:n,name:"query",value:t}))))},x=i.a.forwardRef((function(e,t){return i.a.createElement("div",{ref:t})})),P=null,b=!1,C=Object(c.f)((function(e){var t=e.history;return i.a.createElement("button",{className:"button is-success is-outlined",style:{marginBottom:"10px"},type:"button",onClick:function(){t.push("/proxy")}},"Be a Proxy Peer")})),E=function(e){var t=e.p2wiki,n=Object(r.useState)(""),o=Object(u.a)(n,2),a=o[0],s=o[1],c=Object(r.useState)(""),l=Object(u.a)(c,2),f=l[0],d=l[1],h={},p=null,m=function(e){for(var t,n=(e=(new window.DOMParser).parseFromString(e,"text/html")).querySelectorAll("a[class='image']"),r=0;r<n.length;r++)t=decodeURIComponent(new URL(n[r].href).pathname.slice(6)),n[r].firstChild.src="",n[r].firstChild.srcset="",h[t]&&(".svg"===t.substr(-4,4)&&(h[t].name+=".png"),h[t].renderTo(n[r].firstChild));b=!0,P=e.body.firstChild};return i.a.createElement(i.a.Fragment,null,i.a.createElement(C,null),i.a.createElement(k,{query:a,handleChange:function(e){s(e.target.value)},handleSubmit:function(e){e.preventDefault(),function e(){""!==a&&!1===t.requestArticle(a,(function(e){h=e.media,e.text.getBuffer((function(t,n){m(n.toString()),d(e.Title),t&&console.log(t)}))}))&&(console.log("No peer. Retrying in 3 seconds"),clearInterval(p),p=setTimeout(e,3e3))}()}}),i.a.createElement("div",{className:"container mx-auto"},i.a.createElement("h1",{className:"title text-4xl"},f),i.a.createElement(x,{ref:function(e){e&&b&&P&&(e.innerHTML="",e.appendChild(P),b=!1)}})))},I=function(){return i.a.createElement("footer",{className:"footer"},i.a.createElement("p",{style:{color:"hotpink"}},"P2Wiki made by Subin Siby, Pranav Shridhar and Athul Cyriac Ajay"))};n(452);function S(){var e=["wss://tracker.openwebtorrent.com","wss://tracker.sloppyta.co:443/announce","wss://tracker.novage.com.ua:443/announce","wss://tracker.btorrent.xyz:443/announce"];"localhost"===window.location.hostname&&(e=["ws://localhost:5000"]);var t=new y(e);return t.startClient(),i.a.createElement("div",{style:{textAlign:"center"}},i.a.createElement(w,null),i.a.createElement(E,{p2wiki:t}),i.a.createElement(I,null))}var T=function(){var e=["wss://tracker.openwebtorrent.com","wss://tracker.sloppyta.co:443/announce","wss://tracker.novage.com.ua:443/announce","wss://tracker.btorrent.xyz:443/announce"];return"localhost"===window.location.hostname&&(e=["ws://localhost:5000"]),new y(e).startProxy(),i.a.createElement("div",{style:{textAlign:"center"}},i.a.createElement("h1",null,"Proxy Page"))};n(453);var A=function(){return i.a.createElement("div",{className:"App"},i.a.createElement(s.a,null,i.a.createElement(c.c,null,i.a.createElement(c.a,{exact:!0,path:"/",component:S}),i.a.createElement(c.a,{exact:!0,path:"/proxy",component:T}))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));a.a.render(i.a.createElement(A,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))}},[[212,1,2]]]);
//# sourceMappingURL=main.0f42faf4.chunk.js.map